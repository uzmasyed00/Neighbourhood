<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Moving Companion</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<script type = 'text/javascript' src="knockout/dist/knockout.js"></script>


The name is <span data-bind="text: personName"></span>
    <div data-bind="foreach: placesArray"></div>
    <form id="form-container" class="form-container">
        <label for="address">Address: </label><input id="address" type="textbox">
        <input id="submit" type="button" value="Geocode">
    </form>

    <hr>

    <div id = "map">
    </div>

    <h1>
        Hello Uzma
    </h1>


     <script>
     var map;
     var address;
     var copied_Address;
     var geocodedAddress;
     var geocoder;
     var map_lat_lng;
     var service;
     var placesArray;

     var myViewModel = {
         personName: 'Uzma Syed',
         personAge: 123
     };



     function initMap() {
         map_lat_lng = new google.maps.LatLng(-34.397, 150.644);
         geocoder = new google.maps.Geocoder();
         map = new google.maps.Map(document.getElementById('map'), {
             center: map_lat_lng,
             zoom: 8
         });

         console.log("I have loaded the map")

         document.getElementById('submit').addEventListener('click', function () {
             var address = document.getElementById('address').value;
             console.log("Address when Geocode clicked is", address);
             copied_Address = address;
             console.log("Copied Address is" + copied_Address)
             geocodedAddress = geocodeAddress(address, geocoder, map, function (error, res) {
                 console.log("geocodedAddress aync is is" + res);
                 geocodedAddress = res
                 console.log("geocoded address now after re-assigning is" + geocodedAddress)
                 console.log("Type of geocodedaddress is" + typeof geocodedAddress)
                 console.log("Response returned from the google maps api is", res)
                 var request = {
                     location: res,
                     radius: '50000',
                     types: ['food']
                 };

                 service = new google.maps.places.PlacesService(map);
                 console.log("I have created the instance of service");
                 service.nearbySearch(request, callback)
                 console.log("I have done nearbySearch");

             });
             console.log("Geocoded Address not async is" + geocodedAddress);
         });

     }

     function callback(results, status) {
         console.log("Status of request is" + status)
     if (status == google.maps.places.PlacesServiceStatus.OK) {
         console.log(status)
         console.log(results)
         var results0 = results[0];
         console.log("Results0 geometry is" + results[0].geometry);
         console.log("Length of Results0 is" + results[0].length);
         //console.log("Results0 opennow is" + results[0].opening_hours.open_now)
        /* for (var i=0; i<results[0].get(); i++){
                children_of_place = results[0][i];
                console.log("Children_of_place is" + children_of_place);
            }*/
         placesArray = ko.observableArray(results)
        for (var i = 0; i < results.length; i++) {
            var place = results[i];
            /*for (var j=0; j<place.length; j++){
                children_of_place = place[j];
                console.log("Children_of_place is" + children_of_place);
            }*/
            //var results0 = results[0];
            //console.log("Results0 location is" + results[0].location);
            console.log("Place is" + place)
            console.log("name of place is" + results[i].name)
            console.log("TypeOf name is" + typeof results[i].name)
            addMarker(results[i]);

            //Now we need to add these places to the list view binding
            //construct an observable array




            }
        }
    }

     function addMarker(place) {
         var marker = new google.maps.Marker({
             map: map,
             position: place.geometry.location
         });

        /*var nytimesUrl = 'https://api.nytimes.com/svc/search/v2/articlesearch.json?q=' + place.name + '&sort=newest&api-key=be67cb723daf42fb9cb7741b72018289'
         $.getJSON(nytimesUrl, function (data) {
             console.log("Nytimes URL is" + nytimesUrl)
             console.log("Data Response Docs is" + data.response.docs)
             console.log("First article is " + data.response.docs[0].lead_paragraph)
         });*/

         //https://api.foursquare.com/v2/venues/search?ll=40.7,-74&client_id=2M012SDDV0BMMTKDQSLDPFVSM5CBL141GW42QMFZOEK5A3OQ&client_secret=TGVFIAFCX0IJWHNVL0E15QVOKP1Q22QKQOZYTN2WPBDBSIXB&v=YYYYMMDD

         var infowindow = new google.maps.InfoWindow({
             content: place.name

         });

         marker.addListener('click', function() {
             infowindow.open(map, marker);
         });
     }

     function geocodeAddress(address, geocoder, resultsMap, callback) {
         console.log("address in function geocodeAddress is" + address);
        geocoder.geocode({'address': address}, function(results, status) {
            console.log("results obtained from the geocode function is" + results)
            console.log("status is" + status);
            var latlng
          if (status === 'OK') {
              latlng = results[0].geometry.location
              console.log("latlng is" + latlng)
              resultsMap.setCenter(latlng);
              var marker = new google.maps.Marker({
              map: resultsMap,
              position: latlng
              });
              console.log("I am in geocodeAddress and I have finished setting up the marker")
              console.log("result[0].geometry.location" + latlng)
              callback(null, latlng)
          }

          else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }

   </script>
    <script type = 'text/javascript' src="knockout/dist/knockout.js"></script>
    <script>ko.applyBindings(myViewModel)</script>
    <script>ko.applyBindings({placesArray});</script>

    <script src="js/libs/jquery.min.js"></script>
    <script src="js/script.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMz-JMZ-DxEXfOS8_f1nenbjSSs9Nop_U&v=3&libraries=places&callback=initMap" async defer>
    </script>
</body>
</html>
