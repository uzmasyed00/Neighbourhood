<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Moving Companion</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <script type = 'text/javascript' src="knockout/dist/knockout.js"></script>

<input type="text" id="myInput" placeholder="Search for a particular place..">
    <input id="filter" type="button" value="Filter" onclick=Filter()>



    <ul id = "ul" class="collection" data-bind="foreach: placesArray">
                <li id = "li" class="collection-item" data-bind="visible: visible, text: name"></li>
        </ul>



    <form id="form-container" class="form-container">
        <label for="address">Address: </label><input id="address" type="textbox">
        <input id="submit" type="button" value="Geocode">
    </form>

    <hr>

    <div id = "map">
    </div>


     <script>
     var map;
     var address;
     var copied_Address;
     var geocodedAddress;
     var geocoder;
     var map_lat_lng;
     var service;
     var placesArray;

     var ViewModel = function(){
         placesArray = ko.observableArray()

         }

     function initMap() {
         map_lat_lng = new google.maps.LatLng(-34.397, 150.644);
         geocoder = new google.maps.Geocoder();
         map = new google.maps.Map(document.getElementById('map'), {
             center: map_lat_lng,
             zoom: 8
         });

         document.getElementById('submit').addEventListener('click', function () {
             var address = document.getElementById('address').value;
             copied_Address = address;
             geocodedAddress = geocodeAddress(address, geocoder, map, function (error, res) {
                 geocodedAddress = res
                 var request = {
                     location: res,
                     radius: '50000',
                     types: ['food']
                 };

                 service = new google.maps.places.PlacesService(map);
                 service.nearbySearch(request, callback)

             });
         });

     }

     function Filter(){
        var input, filter, ul, li, a, i;
        input = document.getElementById('myInput');
        filter = input.value.toUpperCase();
        ul = document.getElementById("ul");
        li = ul.getElementsByTagName('li');

        // Loop through all list items, and hide those who don't match the search query
        for (i = 0; i < li.length; i++) {
            console.log("i is" + i);
            console.log("li[i] is" + li[i].innerHTML);
            if (li[i].innerHTML.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
         //now make sure that clicking on the filtered location actually shows only that marker and disables the rest
        /* var filteredPlace = geocodeAddress(input.value, geocoder, map, function (error, res) {
                 filteredPlace = res
                 console.log("result of filtered location is" + res)
             });*/

     }

     function callback(results, status) {
     if (status == google.maps.places.PlacesServiceStatus.OK) {
         console.log(results[0])
         placesArray(results);

        for (var i = 0; i < results.length; i++) {
            var place = results[i];
            addMarker(results[i]);
            }
        }


    }

     function addMarker(place) {
         var marker = new google.maps.Marker({
             map: map,
             position: place.geometry.location
         });

         var infowindow = new google.maps.InfoWindow({
             content: place.name

         });

         marker.addListener('click', function() {
             infowindow.open(map, marker);
         });
     }

     function geocodeAddress(address, geocoder, resultsMap, callback) {
        geocoder.geocode({'address': address}, function(results, status) {
            var latlng
          if (status === 'OK') {
              latlng = results[0].geometry.location
              resultsMap.setCenter(latlng);
              var marker = new google.maps.Marker({
              map: resultsMap,
              position: latlng
              });
              callback(null, latlng)
          }

          else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }

   </script>
    <script src="js/libs/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMz-JMZ-DxEXfOS8_f1nenbjSSs9Nop_U&v=3&libraries=places&callback=initMap"
            async defer>
        </script>
    <script>ko.applyBindings(ViewModel);</script>

</body>
</html>
