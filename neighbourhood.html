<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Moving Companion</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <script type = 'text/javascript' src="knockout/dist/knockout.js"></script>

    <input type="text" id="filter" data-bind="textInput: item_to_be_filtered">

    <ul id = "ul" class="collection" data-bind="foreach: filtered_items">
                <li id ="li" class="collection-item" data-bind="visible: true, text: name"></li>
        </ul>

    <form id="form-container" class="form-container">
        <label for="address">Address: </label><input id="address" type="textbox">
        <input id="submit" type="button" value="Geocode">
    </form>

    <hr>

    <div id = "map">
    </div>


     <script>
     var map;
     var address;
     var copied_Address;
     var geocodedAddress;
     var geocoder;
     var map_lat_lng;
     var service;
     var placesArray;
     var item_to_be_filtered;
     //var filtered_items;
     var final_result;
     var marker;
     var returned_places;
     var markerList = [];
     var viewModel;

     var location_details;
     var location_marker;

     var locations = [
          {title: 'Park Ave Penthouse', location: {lat: 40.7713024,  lng: -73.9632393}},
          {title: 'Chelsea Loft', location: {lat: 40.7444883,  lng: -73.9949465}},
          {title: 'Union Square Open Floor Plan', location: {lat: 40.7347062,  lng:  -73.9895759}},
          {title: 'W 15th Street', location: {lat: 40.740395, lng: -74.002047}},
          {title: '401-405 W 14th St', location: {lat: 40.741130, lng: -74.005748}}
     ];

     var location_info = function(location_details, location_marker){
         var self = this;
         this.location_details = location_details;
         this.location_marker = location_marker;
     }

     var ViewModel = function(){
     	var self = this;
         placesArray = ko.observableArray();
         this.item_to_be_filtered = ko.observable('');
         this.filtered_items = ko.computed(function() {
         	var filterItem = self.item_to_be_filtered().toLowerCase();
         	console.log(filterItem);
             //we just want to show markers for items that are returned in the result list
             //return result  which is a list of matches returned
         	return result_filtered = ko.utils.arrayFilter(placesArray(), function(place) {
                //convert each location to lowercase
         		var title = place.name.toLowerCase()
                //store true if location matches filter
         		var match = title.indexOf(filterItem) > -1;
                if (!match){

                }
         		console.log(title, filterItem, match);

                 /*console.log("filtered_items is" + result_filtered)
                    //hide marker in placesArray
                   // markerList[i].setMap(null);
                    console.log("length of placesArray is" + placesArray.length);
                    console.log("length of result_filtered is" + result_filtered.length);

                    if(placesArray.length >= result_filtered.length ){
                        console.log("I am in forloop")
                        for(var i =0; i < placesArray.length; i++){
                            for(var j =0; j < result_filtered.length; j++){
                                if(placesArray[i] !=result_filtered[j]){
                                    console.log("placesArray[i] is" + placesArray[i])
                                    console.log("result_filtered[j] is" + result_filtered[j])
                                    markerList[i].marker.setVisible(true);
                                }

                                else{
                                    markerList[i].marker.setVisible(false);
                                }
                            }
                        }
            }*/
                //return and store number of matches and their names in the list
                return match; // Returns 'true' or 'false'
          	});

             console.log("result_filtered is" + result_filtered);

             /*for(var i=0; i<result_filtered.length; i++){
                addMarker(result_filtered[i]);
             }*/
         });
         }

     function initMap() {
         map_lat_lng = new google.maps.LatLng(-34.397, 150.644);
         geocoder = new google.maps.Geocoder();
         map = new google.maps.Map(document.getElementById('map'), {
             center: map_lat_lng,
             zoom: 8
         });

         document.getElementById('submit').addEventListener('click', function () {
             var address = document.getElementById('address').value;
             copied_Address = address;
             geocodedAddress = geocodeAddress(address, geocoder, map, function (error, res) {
                 geocodedAddress = res
                 var request = {
                     location: res,
                     radius: '50000',
                     types: ['food']
                 };
                 service = new google.maps.places.PlacesService(map);
                 service.nearbySearch(request, callback)

             });
         });

         viewModel = new ViewModel();
         ko.applyBindings(viewModel);

     }



     function callback(results, status) {
     if (status == google.maps.places.PlacesServiceStatus.OK) {
         console.log(results[0])
         placesArray(results);

         returnedPlaces =  results;
         console.log("returnedPlaces inside the callback is" + returnedPlaces)


         //markerList = [];
        /* if (markerList.length >0){
             for (var i=0; i<markerList.length; i++){
                 markerList[i].setMap(null);
             }
         }*/



        for (var i = 0; i < results.length; i++) {
            var place = results[i];
            console.log("place is" + place);
            addMarker(results[i]);
            markerList.push(marker);
            }
        }

           //create location_info object using results[i] object and markerList[i] object

    }

     function addMarker(place) {
         marker = new google.maps.Marker({
             map: map,
             position: place.geometry.location
         });

         var infowindow = new google.maps.InfoWindow({
             content: place.name

         });

         marker.addListener('click', function() {
             infowindow.open(map, marker);
         });
     }

     function geocodeAddress(address, geocoder, resultsMap, callback) {
        geocoder.geocode({'address': address}, function(results, status) {
            var latlng
          if (status === 'OK') {
              latlng = results[0].geometry.location
              resultsMap.setCenter(latlng);
              var marker = new google.maps.Marker({
              map: resultsMap,
              position: latlng
              });
              callback(null, latlng)
          }

          else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }

   </script>
    <script src="js/libs/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMz-JMZ-DxEXfOS8_f1nenbjSSs9Nop_U&v=3&libraries=places&callback=initMap"
            async defer>
        </script>
    <script>src="https://api.yelp.com/v2/search?term=food&location=San+Francisco"</script>
<!--     <script>ko.applyBindings(ViewModel);</script> -->

</body>
</html>
